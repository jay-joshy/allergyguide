{% set tools = load_data(path="/js/tools_versioning.json") %}
{% set tool_info = tools.oit_calculator %}

<div class="oit_calculator">
	<div class="oit-toolbar">
		<div class="oit-version">
			<span>v{{ tool_info.version }}</span>
			<span class="separator">•</span>
			<a href="{{ get_url(path='@/tools/resources/oit_calculator_changelog.md') }}" target="_blank" class="changelog-link">Changelog</a>
		</div>
		<button id="btn-undo" class="btn-secondary" disabled title="Undo (Ctrl+z)">
			↶ Undo (Ctrl-z)
		</button>
		<button id="btn-redo" class="btn-secondary" disabled title="Redo (Ctrl+y)">
			↷ Redo (Ctrl-y)
		</button>
	</div>
	<!-- Food Selection and Settings -->
	<div class="settings-container">
		<!-- Food A Container -->
		<div class="food-a-container">
			<div class="search-container">
				<input type="text"
				       id="food-a-search"
				       placeholder="Search for foods, protocols, or make custom food..."
				       class="search-input"
				       autocomplete="off"
				>
			</div>
			<!-- Food A settings will be dynamically inserted here -->
		</div>
		<!-- Food B Container -->
		<div class="food-b-container disabled">
			<h3>Optional Transition Food</h3>
			<div class="search-container">
				<input type="text"
				       id="food-b-search"
				       placeholder="Search for food or create one to transition to..."
				       class="search-input"
				       autocomplete="off"
				       disabled
				>
				<button id="clear-food-b" class="clear-food-b" disabled>
					Clear
				</button>
			</div>
			<!-- Food B settings will be dynamically inserted here -->
		</div>
	</div>
	<!-- Dosing Strategy Selection -->
	<div class="dosing-strategy-container oit-hidden-on-init">
		<!-- Dosing strategy buttons will be dynamically inserted here -->
	</div>

	<div class="step-controls-footer oit-hidden-on-init">
		<span class="subtle-text">Use <span class="mini-btn-add">+</span> <span class="mini-btn-remove">−</span> buttons to add/remove steps</span>
	</div>

	<!-- Protocol Output -->
	<div class="output-container">
		<table>
			<thead>
				<tr>
					<th>Step</th>
					<th>Protein (mg)</th>
					<th>Method</th>
					<th>Amount for mixture</th>
					<th>Water for mixture</th>
					<th>Daily amount</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td colspan="6"
					    style="
                            text-align: center;
                            color: var(--oit-text-secondary);
                            padding: 1rem;
                        "
					>
						Select a food or protocol to generate steps.
					</td>
				</tr>
			</tbody>
			<!-- Protocol table will be dynamically generated -->
		</table>
		<div class="bottom-section">
			<!-- Export buttons will be dynamically inserted here -->
			<!-- Warnings Sidebar -->
			<div class="warnings-container oit-hidden-on-init">
				<div class="no-warnings">Protocol passes internal checks.</div>
			</div>
		</div>
	</div>
</div>
<!-- Clickwrap Modal -->
<div id="oit-clickwrap-modal" class="oit-modal-overlay" style="display: none;">
	<div class="oit-modal-content">
		<h2>Provider Attestation</h2>
		<p><i>This tool is strictly for use by licensed healthcare professionals. It does not replace professional medical advice.</i>
		The generated PDF is a draft and <b>must be reviewed and approved by a qualified healthcare professional before use</b>. To generate the PDF, you must confirm the following:</p>
		<div class="oit-modal-checkbox-container">
			<label>
				<input type="checkbox" id="clickwrap-checkbox-0">
				<b>I have reviewed the <a href="{{ get_url(path='@/tools/resources/oit_calculator_terms.md') }}" target="_blank">Terms of Use</a>.</b>
			</label>
			<label>
				<input type="checkbox" id="clickwrap-checkbox-1">
				<span><b>I certify that I am a licensed physician or a healthcare professional acting under the direct supervision of a licensed physician.</b>
				I understand that OIT carries a risk of life-threatening anaphylaxis and other harms and that attempting these protocols without emergency equipment and medical oversight is dangerous. I understand that using this tool without professional medical credentials or using it to self-treat without the supervision of a qualified healthcare professional is a violation of the Terms of Use.</span>
			</label>
			<label>
				<input type="checkbox" id="clickwrap-checkbox-2">
				<span><b>I acknowledge this tool is a calculation and documentation aid only.</b>
				It provides mathematical support for dosing schedules and standardized educational templates, but does not exercise clinical judgment or detect all input or output errors. I assume full responsibility for assessing the patient as an appropriate candidate for OIT, verifying all calculations, and reviewing the provided patient educational material before clinical use.</span>
			</label>
			<label>
				<input type="checkbox" id="clickwrap-checkbox-3">
				<span><b>I understand this produces a draft document.</b>
				It is not valid until I have physically reviewed its contents and signed its first page.</span>
			</label>
		</div>
		<div class="oit-modal-buttons">
			<button id="clickwrap-cancel-btn" class="btn-secondary">Cancel</button>
			<button id="clickwrap-generate-btn" class="btn-export" disabled>Generate PDF</button>
		</div>
	</div>
</div>
<!-- Hidden div to get URL for warnings to pass into JS using zola -->
<div id="url-container"
     data-target-url="{{ get_url(path='@/tools/resources/oit_calculator_validation.md') }}"
     style="display: none;"
></div>

<div id="oit-debug-panel" class="oit-debug-panel">
	<h4>payload decoder</h4>
	<div class="debug-controls">
		<input type="text" id="debug-input" placeholder="b64 here">
		<button id="debug-btn">Decode</button>
	</div>
	<div id="debug-result-container"></div>
</div>
<!-- Load main script -->
<script type="module" src="/js/{{ tool_info.file }}"></script>
